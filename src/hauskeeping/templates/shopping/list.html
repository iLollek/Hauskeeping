{% extends "base.html" %}

{% block title %}Einkaufsliste â€“ Hauskeeping{% endblock %}

{% block content %}
{% set checked_count = items|selectattr('is_checked')|list|length %}
{% set total_count = items|length %}
{% if total_count > 0 %}
{% set progress = (checked_count / total_count * 100)|round|int %}
<div class="mb-4">
    <div class="d-flex justify-content-between align-items-center mb-1">
        <small class="text-muted">Fortschritt</small>
        <small class="text-muted">{{ checked_count }} / {{ total_count }}</small>
    </div>
    <div class="progress" style="height: 10px;">
        <div class="progress-bar {% if progress == 100 %}bg-success{% else %}bg-primary{% endif %}"
             role="progressbar" style="width: {{ progress }}%"
             aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100">
        </div>
    </div>
</div>
{% endif %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h3>Einkaufsliste</h3>
    <div class="d-flex gap-2">
        <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#categoriesModal">
            <i class="bi bi-tags"></i> Kategorien
        </button>
        {% if checked_count > 0 %}
        <form method="POST" action="{{ url_for('shopping.clear_checked') }}"
              onsubmit="return confirm('Alle abgehakten Artikel entfernen?')">
            <button type="submit" class="btn btn-outline-danger btn-sm">
                <i class="bi bi-trash"></i> {{ checked_count }} abgehakte entfernen
            </button>
        </form>
        {% endif %}
    </div>
</div>

<!-- Artikel hinzufuegen -->
<div class="card mb-4">
    <div class="card-body">
        <form method="POST" action="{{ url_for('shopping.add_item') }}" class="row g-2 align-items-end">
            <div class="col-md-5">
                <label for="name" class="form-label">Artikel</label>
                <input type="text" class="form-control" id="name" name="name"
                       placeholder="z.B. Milch, Brot, ..." required>
            </div>
            <div class="col-md-4">
                <label for="category" class="form-label">Kategorie</label>
                <select class="form-select" id="category" name="category">
                    {% for cat in categories %}
                    <option value="{{ cat.slug }}" data-color="{{ cat.color }}">{{ cat.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-plus"></i> Hinzufuegen
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Einkaufsliste -->
{% if items %}
<div class="list-group">
    {% for item in items %}
    <div class="list-group-item d-flex justify-content-between align-items-center
                {% if item.is_checked %}list-group-item-light{% endif %}">
        <div class="d-flex align-items-center gap-3">
            <form method="POST" action="{{ url_for('shopping.toggle_item', item_id=item.id) }}">
                <button type="submit" class="btn btn-sm btn-link p-0">
                    <i class="bi {% if item.is_checked %}bi-check-square-fill text-success{% else %}bi-square text-secondary{% endif %} fs-5"></i>
                </button>
            </form>
            <div>
                <span class="{% if item.is_checked %}text-decoration-line-through text-muted{% endif %}">
                    {{ item.name }}
                </span>
                {% if item.category and item.category in category_map %}
                {% set cat = category_map[item.category] %}
                <span class="badge ms-2" style="background-color: {{ cat.color }}20; color: {{ cat.color }}; border: 1px solid {{ cat.color }}40;">
                    {{ cat.name }}
                </span>
                {% elif item.category %}
                <span class="badge bg-secondary ms-2">{{ item.category|capitalize }}</span>
                {% endif %}
                <br>
                <small class="text-muted">
                    von {{ item.added_by_user.username }} &middot; {{ item.created_at.strftime('%d.%m.%Y') }}
                </small>
            </div>
        </div>
        <form method="POST" action="{{ url_for('shopping.delete_item', item_id=item.id) }}">
            <button type="submit" class="btn btn-sm btn-outline-danger" title="Entfernen">
                <i class="bi bi-x-lg"></i>
            </button>
        </form>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="text-center text-muted py-5">
    <i class="bi bi-cart-x fs-1"></i>
    <p class="mt-2">Die Einkaufsliste ist leer.</p>
</div>
{% endif %}

<!-- Kategorien-Modal -->
<div class="modal fade" id="categoriesModal" tabindex="-1" aria-labelledby="categoriesModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="categoriesModalLabel"><i class="bi bi-tags"></i> Kategorien verwalten</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schliessen"></button>
            </div>
            <div class="modal-body">
                <!-- Neue Kategorie hinzufuegen -->
                <form method="POST" action="{{ url_for('shopping.add_category') }}" class="mb-4">
                    <div class="d-flex gap-2 align-items-end">
                        <div class="flex-grow-1">
                            <label for="cat-name" class="form-label small text-muted">Neue Kategorie</label>
                            <input type="text" class="form-control form-control-sm" id="cat-name" name="name"
                                   placeholder="z.B. IKEA, ALDI, ..." required>
                        </div>
                        <div>
                            <label for="cat-color" class="form-label small text-muted">Farbe</label>
                            <input type="color" class="form-control form-control-color form-control-sm"
                                   id="cat-color" name="color" value="#6c757d">
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm">
                            <i class="bi bi-plus"></i>
                        </button>
                    </div>
                </form>

                <!-- Bestehende Kategorien -->
                {% if categories %}
                <ul class="list-group">
                    {% for cat in categories %}
                    <li class="list-group-item" id="cat-item-{{ cat.id }}">
                        <!-- Anzeigemodus -->
                        <div class="d-flex justify-content-between align-items-center cat-display" id="cat-display-{{ cat.id }}">
                            <div class="d-flex align-items-center gap-2">
                                <span class="rounded-circle d-inline-block" style="width: 14px; height: 14px; background-color: {{ cat.color }};"></span>
                                <span>{{ cat.name }}</span>
                            </div>
                            <div class="d-flex gap-1">
                                <button type="button" class="btn btn-sm btn-outline-secondary" title="Bearbeiten"
                                        onclick="toggleEditMode({{ cat.id }})">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <form method="POST" action="{{ url_for('shopping.delete_category', category_id=cat.id) }}"
                                      onsubmit="return confirm('Kategorie &quot;{{ cat.name }}&quot; wirklich loeschen?')">
                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Loeschen">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                        <!-- Bearbeitungsmodus -->
                        <form method="POST" action="{{ url_for('shopping.edit_category', category_id=cat.id) }}"
                              class="cat-edit d-none" id="cat-edit-{{ cat.id }}">
                            <div class="d-flex gap-2 align-items-center">
                                <input type="text" class="form-control form-control-sm flex-grow-1" name="name" value="{{ cat.name }}" required>
                                <input type="color" class="form-control form-control-color form-control-sm" name="color" value="{{ cat.color }}">
                                <button type="submit" class="btn btn-sm btn-success" title="Speichern">
                                    <i class="bi bi-check-lg"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" title="Abbrechen"
                                        onclick="toggleEditMode({{ cat.id }})">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        </form>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted text-center mb-0">Noch keine Kategorien vorhanden.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleEditMode(catId) {
    const display = document.getElementById('cat-display-' + catId);
    const edit = document.getElementById('cat-edit-' + catId);
    display.classList.toggle('d-none');
    edit.classList.toggle('d-none');
}
</script>
{% endblock %}
